<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="齐博田的个人博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="http://blog.yangrouhubo.com">
    <!--SEO-->

    <meta name="keywords" content="订单号生成,重复下单,发号器">


    <meta name="description" content="订单订单系统作为整个交易系统中的核心，其数据准确性不言而喻。一个常规的订单分为以下几张表

1 订单主表，保存订单的基本信息
2 商品子表，保存订单商品信息
3 支付子表，保存订单的支付信息
4...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>交易系统设计-订单号的生成和如何避免重复下单 | 齐博田的个人博客</title>


    <link rel="alternate" href="/atom.xml" title="齐博田的个人博客" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    


    <link rel="stylesheet" href="//imsun.github.io/gitment/style/default.css">


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1277965304 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1277965304%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>






    

    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(http://snippet.shenliyang.com/img/banner.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='齐博田'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 青春须早为，岂能长少年。 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://blog.yangrouhubo.com">齐博田的个人博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/JAVA/"><i class="fa "></i>JAVA</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/MySQL/"><i class="fa "></i>MYSQL</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/工具/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>时间轴</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="交易系统设计-订单号的生成和如何避免重复下单">
            
	            交易系统设计-订单号的生成和如何避免重复下单
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/交易系统/">交易系统</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/发号器/">发号器</a> <a class="tag-link" href="/tags/订单号生成/">订单号生成</a> <a class="tag-link" href="/tags/重复下单/">重复下单</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2020/05/17</span>
        </span>
        
            <span class="fa-wrap">
                <i class="fa fa-eye"></i>
                <span id="busuanzi_value_page_pv"></span>
            </span>
        
    
</div>
            
            
    </div>
    
    <div class="post-body post-content">
        <h1 id="订单"><a href="#订单" class="headerlink" title="订单"></a>订单</h1><p>订单系统作为整个交易系统中的核心，其数据准确性不言而喻。<br>一个常规的订单分为以下几张表</p>
<ul>
<li>1 订单主表，保存订单的基本信息</li>
<li>2 商品子表，保存订单商品信息</li>
<li>3 支付子表，保存订单的支付信息</li>
<li>4 优惠子表，保存订单的优惠信息。<br>主表和子表之间是一对多的关系，通过订单号进行关联。</li>
</ul>
<h1 id="如何避免重复下单。"><a href="#如何避免重复下单。" class="headerlink" title="如何避免重复下单。"></a>如何避免重复下单。</h1><p>一般的订单处理请求，就是用户提交一个提交订单，发送一个Http请求到服务器，服务器生成一个订单返回给用户。 但是这个过程中，可能会由于用户多次点击提交按钮，或者网络超时重传，而生成多个订单。<br>那么，如何避免重复下单呢？</p>
<ul>
<li><p>解决思路。<br>使得生成订单的过程幂等。</p>
</li>
<li><p>解决方法。  </p>
<ul>
<li>通过主键约束来避免重复提交。<br>服务端提供一个生成订单接口，在提交订单时，把这个订单号一并保存在数据库中，利用数据库的唯一性索引来避免重复提交。</li>
</ul>
</li>
</ul>
<h1 id="如何生成订单号"><a href="#如何生成订单号" class="headerlink" title="如何生成订单号"></a>如何生成订单号</h1><ul>
<li>数据库自增主键<ul>
<li>优势：简单方便</li>
<li>缺点：性能查，以后分库分表也不好拆分。</li>
</ul>
</li>
<li>UUID<ul>
<li>优势：具有足够的随机性，能保障唯一</li>
<li>缺点：<ul>
<li>没有递增性质。第一，如果需要根据时间查询一列订单并排序，则需要额外时间戳来进行排序，加大了存储成本。 第二，自增的主键在数据表插入的时候，可以减少数据的移动和分页的性能消耗。</li>
<li>没有具体的业务含义。</li>
<li>32个16进制组成的字符比较浪费空间</li>
</ul>
</li>
</ul>
</li>
<li>雪花算法（Snowflake）<ul>
<li>原理：<br>将64位的二进制数字分成若干份，每一部分都有特定的业务含义，比如 首位0 （代表正数），时间戳（41位，可供使用69年），机器ID（10位，可以拆分为机房ID和服务器Id），序列号（12位）等等。</li>
<li>改造<br>可以对机器ID和序列号进行改造，比如分出几位代表业务ID。  </li>
<li>缺点  <ul>
<li>依赖系统的时间戳，如果系统时间戳发生了调整（尤其是向前调整），则生成的ID会有概率发生碰撞。</li>
<li>如果系统的并发量不高，则生成的订单最后一位永远都是1，而如果使用这个键最为分库分表的依据，则可能会造成分库分表不均匀的问题。 解决方案：时间戳不记录毫秒只记录到秒，这样在同一个时间窗口内，可以多生成几个号。 第二，起始序列号随机生成。避免了尾号重复的可能性。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="订单号生成服务器的部署"><a href="#订单号生成服务器的部署" class="headerlink" title="订单号生成服务器的部署"></a>订单号生成服务器的部署</h1><p> 其实说成订单号服务器的生成，不如说成业务ID的生成。因为每个业务的ID都有和订单号一样的需求，通过改造雪花算法，在字段中假如业务字段可进行区分不同的业务。</p>
<ul>
<li><p>嵌入到代码中。<br>优势：不需要额外的网络调用即可生成ID<br>缺点：相当于每个服务器上的机器ID都要唯一，也就变相的要求机器码的长度了，另外，为了保证每个服务器的机器码的唯一性，需要zooKeeper进行协调。</p>
</li>
<li><p>独立部署为服务器。<br>和嵌入到代码中正好相反。</p>
</li>
</ul>
<ul>
<li>注意事项<ul>
<li>订单号最好作为自增的，防止数据库分页太多。</li>
<li>如果提前生成订单号，则怎么避免客户端伪造订单号？ 通用的做法时，生成订单号后，返回客户端之前，同时将订单号放入Redis缓存中，在接受到生成订单的请求时，先从Redis缓存中查询是否有相应的订单号，如果有，则进行保存订单，如果没有，则返回失败。</li>
<li>如果同时生成订单号1和订单号2，且号1和号2是有序的，但是提交订单时，号2要比号1提交的早，会导致订单号在系统中的有序性受到干扰，要怎么解决？  这块我还没想到相应的办法。</li>
</ul>
</li>
</ul>
<h1 id="如何解决ABA问题。"><a href="#如何解决ABA问题。" class="headerlink" title="如何解决ABA问题。"></a>如何解决ABA问题。</h1><ul>
<li>什么是ABA问题。<br>假如订单中有一个状态是要填写收件人信息，用户发送请求，修改收件人信息为186<strong><strong>1234，然后点击保存，这时用户发现收件人信息填写错误了，就又修改为138</strong></strong>4567。 正常情况下，订单的收件人信息会经过两次变更，第一次变为186<strong><strong>1234， 第二次变成138</strong></strong>4567。但是如果出现网络异常或者其他原因，造成了第一次请求比第二次请求晚到，所以订单第一次变成138<strong><strong>4567，第二次变成168</strong></strong>1234。就造成了ABA问题。</li>
<li>如何避免ABA问题呢？<br>在订单信息上新增一个版本号字段，在修改订单时，同时返回订单的版本号信息，修改完成后，将修改信息和订单信息同时请求到服务器，服务器在修改订单时，判断订单的版本号是否和请求的版本号一致，如果一致则进行修改，同时修改版本号。不一致则返回失败。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update order set order.recipient = newRecipient, version = version + 1 where order_no = orderNo and version = oldVersion</span><br></pre></td></tr></table></figure>


    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">Qibotian</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/工具/atom/atom主题和插件介绍.html" class="pre-post btn btn-default" title='atom主题和插件介绍'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">atom主题和插件介绍</span>
        </a>
    
    
        <a href="/交易系统/交易系统相关知识点.html" class="next-post btn btn-default" title='交易系统相关问题'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">交易系统相关问题</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	<script type="text/javascript" src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
<script src="https://billts.site/js/gitment.js"></script>
<script>
    var gitment = new Gitment({
        id: window.location.pathname,
        owner:"qibotian",
        repo:"git@github.com:qibotian/gitment.github.io.git",
        oauth: {
          client_id:"be0a9c83797d718940a5",
          client_secret:"a8ffaaf88163d6d82cbb07df6b7e7d8d508b46de"
        },
        perPage:"10",
    });
    gitment.render('comments');
</script>

    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#订单"><span class="toc-text">订单</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#如何避免重复下单。"><span class="toc-text">如何避免重复下单。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#如何生成订单号"><span class="toc-text">如何生成订单号</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#订单号生成服务器的部署"><span class="toc-text">订单号生成服务器的部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#如何解决ABA问题。"><span class="toc-text">如何解决ABA问题。</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
        访问量:
        <strong id="busuanzi_value_site_pv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
        &nbsp; | &nbsp;
        访客数:
        <strong id="busuanzi_value_site_uv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2017
                </span> |
                <span>
                    Powered by <a href="//qibotian.github.io/" class="copyright-links" target="_blank" rel="nofollow">Qibotian | </a> <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>




    <script src="/assets/tagcanvas.min.js?rev=2.9"></script>
    <script>
        var tagOption = {
            textColour: '#444', // 字体颜色
            outlineMethod: 'block', // 选中模式
            outlineColour: '#FFDAB9', // 选中模式的颜色
            interval: 30 || 30, // 动画帧之间的时间间隔，值越大，转动幅度越大
            textHeight: 13,
            outlineRadius: 3,
            freezeActive: true || '', // 选中的标签是否继续滚动
            frontSelect: true || '', // 不选标签云后部的标签
            initial: [0.1, -0.1],
            depth: 0.5,
            decel: 0.95,
            maxSpeed: 0.03,
            reverse: true || '', // 是否反向触发
            fadeIn: 500, // 进入动画时间
            wheelZoom: false || '' // 是否启用鼠标滚轮
        }
        TagCanvas.Start('tag-cloud-3d','',tagOption);
    </script>



    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>